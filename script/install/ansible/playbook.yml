---
- hosts: postal
  # connection: local
  vars:
    # ansible_user: postal
    # Ruby Configuration
    ruby_install_from_source: true
    ruby_download_url: https://cache.ruby-lang.org/pub/ruby/2.5/ruby-2.5.1.tar.gz
    ruby_version: 2.5.1

    ruby_install_gems: [
      "bundler",
      "procodile"
    ]



    # NodeJS Configuration
    nodejs_version: "8.x"



    # MySQL Configuration
    mysql_vendor: mariadb # mysql or mariadb
    # mysql_upstream_version: ~ # MariaDB: 10.2, MySQL: 5.7

    mysql_root_password: "My $3cr3t password"



    # /etc/hosts Configuration
    etc_hosts_add_all_hosts: true
    etc_hosts_pri_dns_name: "example.com"



    # RabbitMQ Configuration
    rabbitmq_version: "3.7.4"

    # Postal Configuration
    postal_hostname: "example.com"
    postal_mysql_password: "p0stalpassw0rd"

    # Certbot (for Let's Encrypt) Configuration
    certbot_admin_email: hello@example.com
    certbot_create_if_missing: yes
    certbot_create_standalone_stop_services: []
    certbot_certs:
      - domains:
        - "{{ postal_hostname }}"

    # Nginx Configuration
    nginx_vhosts:
      - listen: "443 ssl http2"
        server_name: "{{ postal_hostname }}"
        server_name_redirect: "www.{{ postal_hostname }}"
        root: "/opt/postal/app/public"
        extra_parameters: |
          ssl_certificate /etc/letsencrypt/live/{{ postal_hostname }}/fullchain.pem;
          ssl_certificate_key /etc/letsencrypt/live/{{ postal_hostname }}/privkey.pem
          ssl_dhparam /etc/ssl/dhparam.pem;
          ssl_protocols TLSv1.1 TLSv1.2;
          ssl_prefer_server_ciphers on;
          ssl_ciphers EECDH+ECDSA+AESGCM:EECDH+aRSA+AESGCM:EECDH+ECDSA+SHA512:EECDH+ECDSA+SHA384:EECDH+ECDSA+SHA256:ECDH+AESGCM:ECDH+AES256:DH+AESGCM:DH+AES256:RSA+AESGCM:!aNULL:!eNULL:!LOW:!RC4:!3DES:!MD5:!EXP:!PSK:!SRP:!DSS;
    
          location / {
            client_max_body_size 50M;
            try_files $uri $uri/index.html $uri.html @puma;
          }

          location /assets {
            add_header Cache-Control max-age=3600;
          }

          location @puma {
              proxy_set_header X-Real-IP  $remote_addr;
              proxy_set_header Host $host;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto https;
              proxy_pass http://127.0.0.1:5000;
          }
      - listen: "80"
        server_name: "{{ postal_hostname }} www.{{ postal_hostname }}"
        return: "301 https://$host$request_uri"




  roles:
    - role: geerlingguy.ruby
    - role: geerlingguy.nodejs
    - role: geerlingguy.git
    - role: mjanser.mysql
    - role: mrlesmithjr.etc-hosts
    - role: geerlingguy.rabbitmq
    - role: joejordanbrown.postal
    - role: geerlingguy.certbot
    - role: geerlingguy.nginx
  tasks: